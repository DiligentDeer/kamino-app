# Kamino Risk Dashboard

A comprehensive risk dashboard for Kamino lending protocol with real-time analytics, monitoring, and DeFi risk assessment capabilities.

## Features

- ðŸ” **Authentication System**: Complete login/logout functionality with user registration
- ðŸ—„ï¸ **Database Integration**: PostgreSQL integration with SQLAlchemy
- ðŸ“„ **Page Organization**: Structured page system with utilities and caching
- ðŸ³ **Docker Support**: Ready-to-use Docker configuration
- ðŸ“Š **Risk Analytics**: Interactive Plotly visualizations for risk metrics
- ðŸŒ **Web3 Integration**: Direct blockchain interaction with Kamino protocol
- âš¡ **Performance**: Built-in caching for database queries and time consuming tasks using `@st.cached_data` decorator
- ðŸš€ **Modern Tooling**: Uses `uv` for fast dependency management and virtual environments 

## Project Structure

```
kamino_risk_dashboard/
â”œâ”€â”€ main.py                 # Main application entry point
â”œâ”€â”€ pages/                  # Streamlit pages
â”‚   â”œâ”€â”€ login.py           # Authentication page
â”‚   â”œâ”€â”€ logout.py          # Logout page
â”‚   â”œâ”€â”€ page_1.py          # Risk dashboard page 1
â”‚   â”œâ”€â”€ page_2.py          # Risk dashboard page 2
â”‚   â”œâ”€â”€ page_3.py          # Risk dashboard page 3
â”‚   â””â”€â”€ utils/             # Page-specific utilities
â”‚       â”œâ”€â”€ page_1.py      # Utilities for page 1
â”‚       â”œâ”€â”€ page_2.py      # Utilities for page 2
â”‚       â””â”€â”€ page_3.py      # Utilities for page 3
â”œâ”€â”€ src/                   # Core application logic
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ database.py        # Database operations and queries
â”œâ”€â”€ pyproject.toml         # Project configuration and dependencies
â”œâ”€â”€ uv.lock               # Dependency lock file (auto-generated by uv)
â”œâ”€â”€ .gitignore            # Git ignore rules
â”œâ”€â”€ Dockerfile            # Docker configuration
â””â”€â”€ README.md             # This file
```

## Prerequisites

- Python 3.13+
- PostgreSQL database
- [uv](https://docs.astral.sh/uv/) package manager (install with: `curl -LsSf https://astral.sh/uv/install.sh | sh`)

## Setup Instructions

### 1. Install Dependencies

```bash
# Install all dependencies using uv (much faster than pip!)
uv sync

# This will automatically:
# - Create a virtual environment (.venv)
# - Install all dependencies from pyproject.toml
# - Set up the development environment
```

### 2. Environment Configuration

Create a `.env` file in the project root with the following environment variables:

```env
POSTGRES_USER=your_postgres_username
POSTGRES_PASSWORD=your_postgres_password
POSTGRES_HOST=localhost
POSTGRES_PORT=5432
POSTGRES_DB=your_database_name
```

**Important**: The PostgreSQL user must have **write privileges** to the database.

### 3. Running the Application

```bash
# Run the application using uv (no need to activate virtual environment!)
uv run streamlit run main.py

# Or run with specific port
uv run streamlit run main.py --server.port 8501

# For development with auto-reload
uv run streamlit run main.py --server.runOnSave true
```

### 4. Docker Deployment (Optional)

```bash
# Build the Docker image
docker build -t streamlit-app .

# Run the container
docker run -p 80:80 --env-file .env streamlit-app
```

## Usage Guide

### Adding New Pages

1. Create a new Python file in the `pages/` directory
2. Define a function with your page logic
3. Import and register the page in `main.py`

Example:
```python
# pages/my_new_page.py
import streamlit as st

def my_new_page():
    st.title("My New Page")
    st.write("Welcome to my new page!")

# main.py
from pages.my_new_page import my_new_page

my_new_page_page = st.Page(
    my_new_page,
    title="My New Page",
    icon=":material/new_page:",
)

# Add to navigation
pg = st.navigation({
    "Account": [logout_page],
    "Section 1": [page_1_page, page_2_page],
    "Section 2": [page_3_page, my_new_page_page],  # Add here
})
```

### Page Utilities and Caching

For time-consuming operations (like database queries), use the `pages/utils/` directory:

```python
# pages/utils/my_page.py
import streamlit as st
from src.database import my_database_query

@st.cache_data(ttl=60 * 60, show_spinner=False)  # Cache for 1 hour
def my_cached_query():
    return my_database_query()
```

### Database Operations

Add your database queries and operations in the `src/` directory:

```python
# src/database.py
def my_custom_query():
    """Your custom database query"""
    database_url = get_database_url()
    engine = create_engine(database_url)
    
    with engine.connect() as conn:
        result = conn.execute(text("SELECT * FROM my_table"))
        return result.fetchall()
```

### Charting with Plotly

The boilerplate is pre-configured for Plotly. Example usage:

```python
import plotly.express as px
import streamlit as st

# In your page function
data = {'x': [1, 2, 3], 'y': [4, 5, 6]}
fig = px.line(data, x='x', y='y', title='My Chart')
st.plotly_chart(fig)
```

## Authentication System

The authentication system is already set up and includes:

- **User Login**: Email and password authentication
- **User Registration**: New user registration with email whitelist
- **Password Security**: Bcrypt password hashing
- **Session Management**: Streamlit session state management

### User Registration Flow

1. Email must be in the whitelist table
2. Password must be at least 8 characters
3. User data is stored securely with hashed passwords

## Why uv?

This project uses [uv](https://docs.astral.sh/uv/) instead of traditional `pip` and `venv` for several benefits:

- âš¡ **10-100x faster** dependency resolution and installation
- ðŸ”’ **Deterministic builds** with automatic lock file generation
- ðŸŽ¯ **Single tool** replaces pip, pip-tools, pipx, pyenv, twine, virtualenv
- ðŸš€ **Zero configuration** - works out of the box
- ðŸ“¦ **Better dependency management** with groups and optional dependencies

## Development Tips

### Adding Dependencies

```bash
# Add a new package
uv add package-name

# Add a development dependency
uv add --group dev package-name

# Add with specific version
uv add "package-name>=1.0.0"

# Sync dependencies after manual pyproject.toml edits
uv sync
```

### Caching Best Practices

- Use `@st.cache_data` for data that doesn't change often
- Set appropriate TTL (Time To Live) values
- Use `show_spinner=False` for cached functions to avoid loading indicators
- Cache database queries and expensive calculations

### Page Organization

- Keep page logic in `pages/` directory
- Put reusable utilities in `pages/utils/`
- Database operations go in `src/`
- Use descriptive function and file names
- Run `uv sync` after pulling changes to update dependencies
- Use `uv run` to execute commands in the project environment

## Troubleshooting

### uv-Specific Issues

**Command not found: uv**
```bash
# Install uv globally
curl -LsSf https://astral.sh/uv/install.sh | sh
# Restart your terminal or run:
source ~/.bashrc  # or ~/.zshrc
```

**Dependencies not syncing**
```bash
# Force reinstall all dependencies
uv sync --reinstall

# Clear uv cache
uv cache clean
```

**Virtual environment issues**
```bash
# Remove and recreate the virtual environment
rm -rf .venv
uv sync
```

### Database Connection Issues
- Verify PostgreSQL is running
- Check database credentials in `.env`
- Ensure the database exists and user has proper permissions

### Import Errors
- Make sure all dependencies are installed: `uv sync`
- Check if you're using `uv run` to execute commands

### Streamlit Issues
- Clear Streamlit cache: `uv run streamlit cache clear`
- Check for port conflicts if using custom ports
- Use `uv run streamlit run main.py` instead of direct streamlit commands

### Logs

The application includes comprehensive logging. Check the console output for detailed error messages and debugging information.
